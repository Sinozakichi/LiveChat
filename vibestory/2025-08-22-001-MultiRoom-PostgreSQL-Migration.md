---
id: "vibestory-2025-08-22-001"
related_feature: "multiroom-chat-postgresql-migration"
datetime: "2025-08-22T07:15:00+08:00"
stage: "feature-complete"
tags:
  - feature
  - database
  - migration
  - postgresql
  - multiroom
  - bootstrap
summary: "實現多聊天室功能並完成從 SQLite 到 PostgreSQL 的資料庫遷移，同時優化前端介面"
---

## What happened

此次完成了多項重要功能的實現與系統升級工作，主要包括：

1. **多聊天室功能實現**：完成了前篇 vibestory 中提到的「添加聊天室功能，支援多個獨立的聊天空間」目標
   - 實現了聊天室的創建、加入、離開功能
   - 支援多個獨立聊天空間的訊息隔離
   - 完成聊天室用戶管理與權限控制

2. **資料庫遷移**：從 SQLite 成功遷移到 PostgreSQL
   - 設計並實現資料庫遷移系統，支援版本控制
   - 修改 Room 模型結構，適應 Supabase PostgreSQL 中的 UUID 字串型態 ID
   - 更新相關的資料庫查詢邏輯與 GORM 模型定義

3. **前端優化**：
   - 整合 Bootstrap 5 進行 UI 美化，提升使用者體驗
   - 實現響應式設計，適應不同設備螢幕
   - 改善錯誤處理與用戶反饋機制

4. **測試完善**：
   - 擴展 BDD 測試場景，覆蓋多聊天室功能
   - 更新單元測試與整合測試，確保所有新功能都有測試覆蓋
   - 修正測試代碼中的模型初始化方式，適應新的資料庫結構

## Why it's designed like this

1. **多聊天室架構**：
   - 採用 Room 模型作為核心實體，每個聊天室有獨立的訊息流與用戶列表
   - 使用 RoomUser 關聯模型管理用戶與聊天室的多對多關係
   - 實現 BroadcastService 擴展，支援按聊天室 ID 進行訊息廣播

2. **PostgreSQL 遷移**：
   - 選擇 PostgreSQL 作為生產環境資料庫，提供更好的可擴展性與穩定性
   - 使用 Supabase 託管 PostgreSQL 服務，簡化運維工作
   - 實現自定義遷移系統，而非依賴 GORM 的 AutoMigrate，以精確控制表結構

3. **UUID 作為主鍵**：
   - 使用 UUID 字串作為主鍵，而非自增整數，提供更好的分散式系統支援
   - 修改模型結構，從嵌入 gorm.Model 改為直接定義欄位，精確控制欄位型態
   - 更新查詢邏輯，使用字串 ID 進行查詢而非整數 ID

4. **前端設計**：
   - 使用純 JavaScript 實現前端邏輯，不依賴 jQuery 或其他框架
   - 採用 Bootstrap 5 提供現代化 UI 組件與響應式設計
   - 實現聊天室列表與聊天界面的無縫切換

## Reflection

本次開發過程中，我們成功實現了前篇 vibestory 中提出的多項「Next」目標，特別是「添加聊天室功能」和「實現訊息持久化」。同時，我們還進行了資料庫的升級與前端優化工作。

最大的挑戰來自於資料庫遷移過程。原本以為只需修改連接字串和驅動就能完成遷移，但實際上遇到了更多技術挑戰：

1. **ID 型態不匹配**：Supabase 中使用 UUID 字串作為主鍵，而我們的模型使用 uint 型態 ID，導致資料類型不匹配錯誤。
2. **外鍵約束問題**：使用 GORM 的 AutoMigrate 時遇到了外鍵約束無法實現的錯誤。
3. **測試適配**：需要更新所有測試檔案中的模型初始化方式，確保測試可以在新的資料庫結構下正常運行。

最終，我們通過重新設計模型結構、使用原生 SQL 創建表結構、以及全面更新測試代碼，成功解決了這些挑戰。這些改動不僅解決了當前問題，還為未來的功能擴展和系統擴展奠定了更堅實的基礎。

多聊天室功能的實現也比預期更加複雜，特別是在處理用戶加入/離開聊天室、訊息隔離、以及聊天室狀態管理方面。但通過嚴格遵循分層架構和依賴注入原則，我們成功地保持了代碼的可維護性和可測試性。

## Next

- **用戶認證與授權**：實現完整的用戶註冊、登入和權限管理系統
- **訊息類型擴展**：支援文字以外的訊息類型，如圖片、檔案等
- **訊息持久化優化**：實現訊息歷史查詢、分頁和搜索功能
- **聊天室管理功能**：添加聊天室設置、邀請機制和權限控制
- **系統監控與日誌**：實現更完善的系統監控和日誌記錄
- **效能優化**：針對大量用戶和訊息場景進行效能優化
- **分布式部署**：實現 Redis Pub/Sub 機制，支援多實例部署
